function flickerBox(d,a,c,b){var g=a,k=b.fBackLoop,h=b.showInfo;if(h)var e=b.infos;var z=b.showEdit,u=b.flickerText,v=k||h,m=g,n=g,f=0,p=0,w=1/g/2*1E3,q=1/g/2*1E3,x=0,y=0,A=0;this.setFlickerInterval=function(a){window.clearInterval(t);t=window.setInterval(this.flicker,a)};this.changeFreq=function(a){n=m=g=a;p=f=0;w=1/g/2*1E3};this.stop=function(){window.clearInterval(t);h&&window.clearInterval(E)};this.updateFreq=function(){newf=$(B).children("input").val();this.changeFreq(newf)};this.creatDOM=function(){var a=
document.createElement("div");a.className="fboxcontainer";a.setAttribute("id",d);var b=document.createElement("div");b.className="fbox";b.innerHTML=c;var e=document.createElement("div");e.className="fboxdata";var k=document.createElement("div");document.createElement("div");var k=document.createElement("div"),f=document.createElement("input");f.value=g;k.className="fboxopts";k.appendChild(f);a.appendChild(b);h&&a.appendChild(e);z&&a.appendChild(k);$("div.stimulator")[0].appendChild(a)};this.creatDOM();
a=$("div#"+d)[0];var s=$(a).children("div.fbox")[0];if(h)var F=$(a).children("div.fboxdata")[0];if(z){var B=$(a).children("div.fboxopts")[0];$(B).children("input")}this.resetminmax=function(){n=m=g;p=f=0};this.flicker=function(){colorProperty=!0==u?s.style.color:s.style.backgroundColor;if("white"!=colorProperty){if(colorProperty="white",v){r=(new Date).getTime();if(h){cf=1E3/(r-l);cf>n&&(n=cf);cf<m&&(m=cf);f=(f*p+cf)/(p+1);p++;isFinite(f)||(n=m=g,p=f=0);var a="";e.curF&&(a+="Freq: "+cf.toFixed(2)+
"Hz<br />");e.avgF&&(a+="Avg: "+f.toFixed(2)+"Hz<br />");e.rangeF&&(a+="Range: "+m.toFixed(2)+" <  f  < "+n.toFixed(2)+"<br />");e.curPer&&(a+="Period: "+(r-l)+"ms<br />");e.curDuty&&(a+="Duty: "+((C-l)/(r-l)*100).toFixed(2)+"%");F.innerHTML=a}if(k){var a=x,b=(r-l)/1E3,c=w-(r-l)/2;x=c;y+=c*b;A=0<b?(c-a)/b:0;q+=0.5*x+0*y+0*A;0>=q&&(q=w)}l=(new Date).getTime()}}else colorProperty="black",v&&(C=(new Date).getTime());!0==u?s.style.color=colorProperty:s.style.backgroundColor=colorProperty;t=setTimeout(D,
q)};if(v)var l=(new Date).getTime(),C=(new Date).getTime(),r=(new Date).getTime();s.style.backgroundColor=!0==u?"black":"white";var D=this.flicker,t=setTimeout(D,q);if(h)var E=window.setInterval(this.resetminmax,6E4)}
function fixStyle(d){var a=0.9*$(window).width(),c=0.9*$(window).height(),b=a/d.cols;boxesCount<d.cols&&(b=a/boxesCount);a=c/Math.ceil(boxesCount/(a/b));$("div.fboxcontainer").css("width",b.toFixed(0)+"px");$("div.fboxcontainer").css("height",a.toFixed(0)+"px");$("div.fbox").css("line-height",a.toFixed(0)+"px");b<a?$("div.fbox").css("font-size",(b*d.fontS).toFixed(0)+"px"):$("div.fbox").css("font-size",(a*d.fontS).toFixed(0)+"px");!0==d.fontB?$("div.fbox").css("font-weight","bold"):$("div.fbox").css("font-weight",
"normal")}
function creatBoxes(d,a){$("div.stimulator").removeClass("displayNone");var c=[];for(i=0;i<d.length;i++)c[i]=new flickerBox(i,d[i].f,d[i].text,d[i].opts);$("div.fboxopts").children("input").change(function(){var a=$(this).parent("div.fboxopts").parent("div.fboxcontainer").attr("id");c[a].updateFreq()});boxesCount=d.length;fixStyle(a);$("div.stimulator").append('<div class="setupBtn"></div>');$("div.setupBtn").click(function(){$("div.fboxcontainer").each(function(){var a=$(this).attr("id");c[a].stop()});
c=[];$("div.stimulator").empty();$("div.stimulator").addClass("displayNone");$("div.setupPage").removeClass("displayNone")})}
function setupStimulator(){"undefined"===typeof boxesCount&&(boxesCount=6);var d;d='<div>Note: The performance of this stimulator (the exact frequency of stimulations) highly depends on the machine and the web browser running it. It is not intended for academic use, rather it is a fast solution to test simple SSVEP setups. We sugest the latest version of <a href="https://www.google.com/intl/en/chrome/browser/">Google Chrome</a> for the best performance.</div><div class="versionInfo">JS SSVEP Stimulator version 2014.01.01 - By Omid Sani</div>';$("div.setupPage").append('<form><div class="setupTable"><table><caption>Setup an SSVEP stimulator</caption><thead><tr><th>#</th><th>Frequency</th><th>Text</th><th></th></tr></thead><tbody></tbody><tfoot><tr><td></td><td></td><td></td><td><div class="addBtn"></div></td></tr><tr><td></td><td>Font Size: <select name="fontS"><option value="100" selected="selected">100%</option><option value="50">50%</option></select></td><td><input type="checkbox" name="fBackLoop" checked="checked">Feedback Control Loop<br /><input type="checkbox" name="avgF">Show Averages</td></td><td></td></tr><tr><td></td><td><input type="checkbox" name="fontB" checked="checked">Bold Font</td><td><input type="radio" name="flickerer" value="text" checked="checked">Flicker Texts<br/><input type="radio" name="flickerer" value="box">Flicker Boxes</td></tr><tr><td></td><td><input type="submit" name="submit" value="" class="playBtn"><br/>Run</td><td><div class="saveBtn"></div><br/>Save This Setup</td><td></td></tr></tfoot></table></div><div class="preDef"><table><caption>Predefined models</caption><tbody><tr><td><div class="loadBtn"></div><br/>Load</td></tr><tr><td><div class="fullKBBtn"></div><br/>Full KB</td></tr></tbody></table></div></form><div>'+
d+"</div>");for(i=0;i<boxesCount;i++)$("div.setupPage").find("div.setupTable").find("tbody").append("<tr><td>"+(i+1)+'</td><td><input type="text" name="freq" value="'+(7+i)+'"></td><td><input type="text" name="text" value="'+String.fromCharCode(65+i)+'"></td><td><div class="removeBtn"></div></td></tr>');$("div.setupPage").find(".addBtn").click(function(){i=$("div.setupPage").find("div.setupTable").find("tbody").find("tr").size();$("div.setupPage").find("div.setupTable").find("tbody").append("<tr><td>"+
(i+1)+'</td><td><input type="text" name="freq" value="'+(7+i)+'"></td><td><input type="text" name="text" value="'+String.fromCharCode(65+i)+'"></td><td><div class="removeBtn"></div></td></tr>');$("div.setupPage").find(".removeBtn").click(function(){$(this).parent("td").parent("tr").remove()})});$("div.setupPage").find(".removeBtn").click(function(){$(this).parent("td").parent("tr").remove()});$("div.setupPage").find(".saveBtn").click(function(){var a={showInfo:!1,showEdit:!1,flickerText:!1,fBackLoop:!1,
infos:{curF:!1,avgF:!0,rangeF:!1,curPer:!1,curDuty:!1}};$("div.setupPage").find("tfoot").find('input[name="fBackLoop"]').is(":checked")&&(a.fBackLoop=!0);$("div.setupPage").find("tfoot").find('input[name="avgF"]').is(":checked")&&(a.showInfo=!0);$("div.setupPage").find("tfoot").find('input[name="flickerer"][value="text"]').is(":checked")&&(a.flickerText=!0);var c=[];$("div.setupPage").find("div.setupTable").find("tbody").find("tr").each(function(a,b){var d=$(b).children("td").children('input[name="freq"]').val(),
e=$(b).children("td").children('input[name="text"]').val();c[a]={f:d,text:e}});var b={cols:3,fontS:1,fontB:!1};$("div.setupPage").find("tfoot").find('input[name="fontB"]').is(":checked")&&(b.fontB=!0);50==$("div.setupPage").find("tfoot").find('select[name="fontS"]').val()&&(b.fontS=0.5);$.cookie("JSSSVEPSetup",JSON.stringify({ver:1,boxes:c,boxOpts:a,options:b}),{expires:3650})});$("div.setupPage").find(".loadBtn").click(function(){var a=JSON.parse($.cookie("JSSSVEPSetup"));if(null!==a&&1==a.ver){$("div.setupPage").find("div.setupTable").find("tbody").find("tr").remove();
boxesCount=a.boxes.length;for(i=0;i<boxesCount;i++)$("div.setupPage").find("div.setupTable").find("tbody").append("<tr><td>"+(i+1)+'</td><td><input type="text" name="freq" value="'+a.boxes[i].f+'"></td><td><input type="text" name="text" value="'+a.boxes[i].text+'"></td><td><div class="removeBtn"></div></td></tr>');$("div.setupPage").find(".removeBtn").click(function(){$(this).parent("td").parent("tr").remove()});$("div.setupPage").find("tfoot").find('input[name="fBackLoop"]')[0].checked=a.boxOpts.fBackLoop;
$("div.setupPage").find("tfoot").find('input[name="avgF"]')[0].checked=a.boxOpts.showInfo;$("div.setupPage").find("tfoot").find('input[name="flickerer"][value="text"]')[0].checked=a.boxOpts.flickerText;$("div.setupPage").find("tfoot").find('input[name="flickerer"][value="box"]')[0].checked=!a.boxOpts.flickerText;$("div.setupPage").find("tfoot").find('input[name="fontB"]')[0].checked=a.options.fontB;var c=$("div.setupPage").find("tfoot").find('select[name="fontS"]')[0];c.selectedIndex=0;0.5==a.options.fontS&&
(c.selectedIndex=1)}});$("div.setupPage").find(".fullKBBtn").click(function(){$("div.setupPage").find("div.setupTable").find("tbody").empty();boxesCount=26;for(i=0;i<boxesCount;i++)$("div.setupPage").find("div.setupTable").find("tbody").append("<tr><td>"+(i+1)+'</td><td><input type="text" name="freq" value="'+((12+i)/2).toFixed(1)+'"></td><td><input type="text" name="text" value="'+String.fromCharCode(65+i)+'"></td><td><div class="removeBtn"></div></td></tr>');$("div.setupPage").find(".removeBtn").click(function(){$(this).parent("td").parent("tr").remove()})});
$("div.setupPage").find("form").submit(function(a){a.preventDefault();$("div.setupPage").addClass("displayNone");var c={showInfo:!1,showEdit:!1,flickerText:!1,fBackLoop:!1,infos:{curF:!1,avgF:!0,rangeF:!1,curPer:!1,curDuty:!1}};$("div.setupPage").find("tfoot").find('input[name="fBackLoop"]').is(":checked")&&(c.fBackLoop=!0);$("div.setupPage").find("tfoot").find('input[name="avgF"]').is(":checked")&&(c.showInfo=!0);$("div.setupPage").find("tfoot").find('input[name="flickerer"][value="text"]').is(":checked")&&
(c.flickerText=!0);var b=[];$("div.setupPage").find("div.setupTable").find("tbody").find("tr").each(function(a,d){var h=$(d).children("td").children('input[name="freq"]').val(),e=$(d).children("td").children('input[name="text"]').val();b[a]={f:h,text:e,opts:c}});a={cols:3,fontS:1,fontB:!1};$("div.setupPage").find("tfoot").find('input[name="fontB"]').is(":checked")&&(a.fontB=!0);50==$("div.setupPage").find("tfoot").find('select[name="fontS"]').val()&&(a.fontS=0.5);creatBoxes(b,a);return!1})}
window.setupStimulator=setupStimulator;